# Access polices

Объект описания политик доступа к выполнению метода имеет следующую структуру:

```
policy: {
  name: 'RULE_NAME',
  instrumentId: 1,
  minLevel: 'guest',
  guest: {
    parameters: {
      view: ['default'],
    },
    accessible: true,
  },
  free: {
    parameters: {
      view: ['default'],
    },
    accessible: true,
  },
  priority: {
    accessible: true,
  }
},
```

где

name - имя правила

instrumentId - идентификатор разрешения, которое необходимо проверить, для разрешения или запрета доступа к платной части функциональности

minLevel - минимальный уровень доступа. На данный момент выделено три типа:

*   guest не авторизированный пользователь с гостевым токеном (api.auth.guest())
*   free авторизированный пользователь в системе по паролю или токену пользователя, но не имеющий прав доступа к платной функциональности
*   priority пользователь имеющий доступ к платным функциям метода посредством оплаты доступа, триального периода либо иным предусмотренными способом, который приводит к записи о получении прав доступа к инструменту на определенный период

Проверка происходит в следующем порядке:

В начале проверяется минимальный необходимый уровень доступа для получения результата выполнения контролируемого метода. Если текущий уровень ниже необходимого, то выполнение метода не происходит, а в качестве результата отправляется ошибка соответствующей причины отказа доступа

В случае наличия необходимого уровня доступа, проверка продолжается уже по объекту описания текущего уровня доступа пользователя, который на данный момент имеет следующий вид:

```
guest: {
  parameters: {
    view: ['default'],
  },
  accessible: true,
},
```

где

parameters - описывает возможные варианты значений входных параметров для данного уровня доступа

accessible - булево значение, которое включает или отключает доступ к методу при данном уровне доступа

В случае если accessible имеет значение true, идет проверка входных параметров если они заданы в объекте parameters

# Limit rate

Проверка ограничения доступа происходит в тех методах апи в которых включены проверки.

Осуществляется подсчетом вызовов для каждого авторизированного пользователя по всем токенам, либо для по каждому токену в случае гостевого доступа.

установленный лимит 1000 обращений в минуту

Если лимит достигнут, включается 6-ти ступенчатая система бана доступа, которая задает ограничение доступа на 1 мин, 3 мин, 15 мин , 1 час, 6 часов**,** 24 часа. Эскалация длительности бана происходит в случае если через в течении первой минуты после окончания предидущего периода был превышен лимит запросов

# Пример метода контролируемого лимитами и политикой доступа

```
({
  parameters: {
    arg1: 'string',
    arg2: 'number',
  },
  access: 'token',
  policy: {
    name: 'TEST',
    instrumentId: 1,
    minLevel: 'guest',
    guest: {
      parameters: {
        arg1: ['default'],
      },
      accessible: true,
    },
    free: {
      parameters: {
        arg1: ['default'],
      },
      accessible: true,
    },
    priority: {
      accessible: true,
    }
  },
  async method({arg1, arg2}) {
    {
      const policy = application.resources
      .application.api.collection.FOLDER_NAME['1']
      .JS_FILE_NAME.exports.policy;
      const argv = {
        arg1,
        arg2,
      };
      const accountId = context.accountId || -1;
      const limits = await domain.firewall.limitRate(context);
      if (!limits.access)
        return limits.error;
      const validation = await domain.policy.check(accountId, policy, argv);
      if (!validation.access)
        return validation.error;
    }

    // rout logic
  },
})
```